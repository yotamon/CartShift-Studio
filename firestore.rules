rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }

    function getUserId() {
      return request.auth.uid;
    }

    function getUserData() {
      return get(/databases/$(database)/documents/portal_users/$(getUserId())).data;
    }

    function isAgency() {
      return isAuthenticated() &&
        exists(/databases/$(database)/documents/portal_users/$(getUserId())) &&
        (getUserData().get('isAgency', false) == true || getUserData().get('accountType', '') == 'AGENCY');
    }

    function isMember(orgId) {
      return isAuthenticated() && (
        isAgency() ||
        exists(/databases/$(database)/documents/portal_members/$(orgId + '_' + getUserId()))
      );
    }

    function isMemberAdmin(orgId) {
      return isAuthenticated() && (
        isAgency() || (
          exists(/databases/$(database)/documents/portal_members/$(orgId + '_' + getUserId())) &&
          get(/databases/$(database)/documents/portal_members/$(orgId + '_' + getUserId())).data.get('role', 'member') in ['owner', 'admin']
        )
      );
    }

    // Portal Users - authenticated users can read/write their own, read all others
    match /portal_users/{userId} {
      allow read: if isAuthenticated() && (getUserId() == userId || isAgency());
      allow create: if isAuthenticated() && getUserId() == userId;
      allow update: if isAuthenticated() && getUserId() == userId;
      allow delete: if false;
    }

    // Portal Organizations - allow all authenticated users to read (prevents permission errors)
    match /portal_organizations/{orgId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && request.resource.data.get('createdBy', '') == getUserId();
      allow update, delete: if isMemberAdmin(orgId);
    }

    // Portal Members - allow read if authenticated, write if admin
    match /portal_members/{memberId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update, delete: if isAuthenticated() && (isAgency() || isMemberAdmin(resource.data.orgId));
    }

    // Portal Invites - public read for invite acceptance, authenticated write
    match /portal_invites/{inviteId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAuthenticated() && (isAgency() || isMemberAdmin(request.resource.data.orgId));
    }

    // Portal Requests
    match /portal_requests/{requestId} {
      allow read: if isAuthenticated() && (isAgency() || isMember(resource.data.orgId));
      allow create: if isAuthenticated() && (isAgency() || isMember(request.resource.data.orgId));
      allow update, delete: if isAuthenticated() && (isAgency() || isMember(resource.data.orgId));
    }

    // Portal Comments
    match /portal_comments/{commentId} {
      allow read: if isAuthenticated() && (isAgency() || isMember(resource.data.orgId));
      allow create: if isAuthenticated() && (isAgency() || isMember(request.resource.data.orgId));
      allow update, delete: if isAuthenticated() && (isAgency() || isMember(resource.data.orgId));
    }

    // Portal Files
    match /portal_files/{fileId} {
      allow read: if isAuthenticated() && (isAgency() || isMember(resource.data.orgId));
      allow create: if isAuthenticated() && (isAgency() || isMember(request.resource.data.orgId));
      allow update, delete: if isAuthenticated() && (isAgency() || isMember(resource.data.orgId));
    }

    // Portal Notifications - users can only access their own
    match /portal_notifications/{notificationId} {
      allow read: if isAuthenticated() && (resource == null || resource.data.userId == getUserId());
      allow create: if isAuthenticated() && request.resource.data.userId == getUserId();
      allow update, delete: if isAuthenticated() && resource != null && resource.data.userId == getUserId();
    }

    // Portal Pricing Requests
    match /portal_pricing_requests/{requestId} {
      allow read: if isAuthenticated() && (isAgency() || isMember(resource.data.orgId));
      allow create: if isAuthenticated() && (isAgency() || isMember(request.resource.data.orgId));
      allow update, delete: if isAuthenticated() && (isAgency() || isMember(resource.data.orgId));
    }

    // Portal Activities
    match /portal_activities/{activityId} {
      allow read: if isAuthenticated() && (isAgency() || isMember(resource.data.orgId));
      allow create: if isAuthenticated() && (isAgency() || isMember(request.resource.data.orgId));
      allow update, delete: if false;
    }

    // Agencies - users can read all, write only to their own (document ID = user ID)
    match /agencies/{agencyId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && getUserId() == agencyId;
    }

    // Default: deny all other access
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
