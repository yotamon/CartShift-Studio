// Rules updated
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    function isAuthenticated() {
      return request.auth != null;
    }

    function getUserId() {
      return request.auth.uid;
    }

    function isMemberOfOrg(orgId) {
      return isAuthenticated() &&
             orgId != null && orgId != '' &&
             exists(/databases/$(database)/documents/portal_members/$(orgId + '_' + getUserId()));
    }

    function isOrgOwner(orgId) {
      return isAuthenticated() &&
             orgId != null && orgId != '' &&
             exists(/databases/$(database)/documents/portal_organizations/$(orgId)) &&
             get(/databases/$(database)/documents/portal_organizations/$(orgId)).data.createdBy == getUserId();
    }

    function isAgencyUser() {
      // Robust agency check
      return isAuthenticated() &&
             exists(/databases/$(database)/documents/portal_users/$(getUserId())) &&
             (
               get(/databases/$(database)/documents/portal_users/$(getUserId())).data.get('isAgency', false) == true ||
               get(/databases/$(database)/documents/portal_users/$(getUserId())).data.get('accountType', '') == 'AGENCY'
             );
    }

    // Helper to check if user has access to an organization
    function canAccessOrg(orgId) {
      return isAuthenticated() &&
             orgId != null && orgId != '' && (
        isAgencyUser() ||
        isMemberOfOrg(orgId) ||
        isOrgOwner(orgId)
      );
    }

    function getMemberDoc(orgId) {
      return get(/databases/$(database)/documents/portal_members/$(orgId + '_' + getUserId()));
    }

    function isOrgAdmin(orgId) {
      return isMemberOfOrg(orgId) && (
        getMemberDoc(orgId).data.get('role', '') == 'owner' ||
        getMemberDoc(orgId).data.get('role', '') == 'admin'
      );
    }

    function canAdminOrg(orgId) {
      return isAuthenticated() && (
        isOrgOwner(orgId) ||
        isAgencyUser() ||
        isOrgAdmin(orgId)
      );
    }

    match /portal_users/{userId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && getUserId() == userId;
      allow update: if isAuthenticated() && getUserId() == userId;
      allow delete: if false;
    }

    match /portal_organizations/{orgId} {
      // Agency users can read any organization, members can read their own org
      allow read: if isAuthenticated() && (
        isAgencyUser() ||
        resource == null ||
        exists(/databases/$(database)/documents/portal_members/$(orgId + '_' + getUserId())) ||
        resource.data.createdBy == getUserId()
      );
      allow create: if isAuthenticated() && request.resource.data.get('createdBy', '') == getUserId();
      // Allow admins OR members to update (needed for Shopify integration settings)
      allow update: if canAdminOrg(orgId) || isMemberOfOrg(orgId);
      allow delete: if false;
    }

    match /portal_members/{memberId} {
      allow read: if isAuthenticated() && (
        isAgencyUser() ||
        resource == null ||
        memberId == (resource.data.get('orgId', '') + '_' + getUserId()) ||
        canAccessOrg(resource.data.get('orgId', ''))
      );
      allow create: if isAuthenticated() && (
        memberId == (request.resource.data.get('orgId', '') + '_' + getUserId()) ||
        isOrgOwner(request.resource.data.get('orgId', ''))
      );
      allow update: if resource != null && canAdminOrg(resource.data.get('orgId', ''));
      allow delete: if false;
    }

    match /portal_invites/{inviteId} {
      allow read: if isAuthenticated() && (
        resource == null ||
        resource.data.get('email', '') == request.auth.token.email ||
        canAccessOrg(resource.data.get('orgId', '')) ||
        resource.data.get('isAgency', false) == true
      );
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && (
        resource == null ||
        resource.data.get('email', '') == request.auth.token.email ||
        canAccessOrg(resource.data.get('orgId', '')) ||
        isAgencyUser()
      );
      allow delete: if resource != null && canAdminOrg(resource.data.get('orgId', ''));
    }

    match /portal_requests/{requestId} {
      allow read: if isAuthenticated() && (
        isAgencyUser() ||
        resource == null ||
        resource.data.get('createdBy', '') == getUserId() ||
        canAccessOrg(resource.data.get('orgId', ''))
      );
      allow create: if isAuthenticated() && (
        isAgencyUser() ||
        isMemberOfOrg(request.resource.data.get('orgId', '')) ||
        isOrgOwner(request.resource.data.get('orgId', ''))
      );
      allow update: if isAuthenticated() && (
        resource == null ||
        resource.data.get('createdBy', '') == getUserId() ||
        canAccessOrg(resource.data.get('orgId', ''))
      );
      allow delete: if false;
    }

    match /portal_comments/{commentId} {
      function getRequestOrgIdFromRequest() {
        return exists(/databases/$(database)/documents/portal_requests/$(request.resource.data.get('requestId', '')))
          ? get(/databases/$(database)/documents/portal_requests/$(request.resource.data.get('requestId', ''))).data.get('orgId', '')
          : '';
      }
      allow read: if isAuthenticated() && (
        isAgencyUser() ||
        resource == null ||
        canAccessOrg(resource.data.get('orgId', '')) ||
        resource.data.get('userId', '') == getUserId()
      );
      allow create: if isAuthenticated() && (
        isAgencyUser() ||
        isMemberOfOrg(getRequestOrgIdFromRequest()) ||
        isOrgOwner(getRequestOrgIdFromRequest())
      );
      allow update: if isAuthenticated() && (
        resource == null ||
        resource.data.get('userId', '') == getUserId() ||
        isAgencyUser()
      );
      allow delete: if isAuthenticated() && (
        resource == null ||
        resource.data.get('userId', '') == getUserId() ||
        isAgencyUser()
      );
    }

    match /portal_files/{fileId} {
      allow read: if isAuthenticated() && (
        isAgencyUser() ||
        resource == null ||
        canAccessOrg(resource.data.get('orgId', '')) ||
        resource.data.get('uploadedBy', '') == getUserId()
      );
      allow create: if isAuthenticated() && (
        isAgencyUser() ||
        isMemberOfOrg(request.resource.data.get('orgId', '')) ||
        isOrgOwner(request.resource.data.get('orgId', ''))
      );
      allow update, delete: if isAuthenticated() && (
        resource == null ||
        resource.data.get('uploadedBy', '') == getUserId() ||
        isAgencyUser()
      );
    }

    match /portal_notifications/{notificationId} {
      allow read: if isAuthenticated() && (
        isAgencyUser() ||
        resource == null ||
        resource.data.get('userId', '') == getUserId()
      );
      allow write: if isAuthenticated() && (
        isAgencyUser() ||
        resource == null ||
        resource.data.get('userId', '') == getUserId() ||
        request.resource.data.get('userId', '') == getUserId()
      );
    }

    match /portal_pricing_requests/{requestId} {
      allow read: if isAuthenticated() && (
        isAgencyUser() ||
        resource == null ||
        canAccessOrg(resource.data.get('orgId', '')) ||
        resource.data.get('createdBy', '') == getUserId()
      );
      allow create: if isAuthenticated() && (
        isAgencyUser() ||
        isMemberOfOrg(request.resource.data.get('orgId', '')) ||
        isOrgOwner(request.resource.data.get('orgId', ''))
      );
      allow update: if isAuthenticated() && (
        resource == null ||
        canAccessOrg(resource.data.get('orgId', '')) ||
        resource.data.get('createdBy', '') == getUserId()
      );
      allow delete: if false;
    }

    match /portal_activities/{activityId} {
      allow read: if isAuthenticated() && (
        isAgencyUser() ||
        resource == null ||
        resource.data.get('userId', '') == getUserId() ||
        canAccessOrg(resource.data.get('orgId', ''))
      );
      allow create: if isAuthenticated();
      allow update, delete: if false;
    }

    match /portal_consultations/{consultationId} {
      allow read: if isAuthenticated() && (
        isAgencyUser() ||
        resource == null ||
        resource.data.get('createdBy', '') == getUserId() ||
        canAccessOrg(resource.data.get('orgId', ''))
      );
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && (
        resource == null ||
        isAgencyUser() ||
        resource.data.get('createdBy', '') == getUserId() ||
        canAccessOrg(resource.data.get('orgId', ''))
      );
      allow delete: if isAuthenticated() && isAgencyUser();
    }

    // Testimonials - clients can create/read their own, agency can read/update all
    match /portal_testimonials/{testimonialId} {
      allow read: if isAuthenticated() && (
        isAgencyUser() ||
        resource == null ||
        resource.data.get('userId', '') == getUserId() ||
        canAccessOrg(resource.data.get('orgId', ''))
      );
      allow create: if isAuthenticated() && (
        isMemberOfOrg(request.resource.data.get('orgId', '')) ||
        isOrgOwner(request.resource.data.get('orgId', ''))
      );
      allow update: if isAuthenticated() && (
        isAgencyUser() ||
        (resource.data.get('userId', '') == getUserId() && resource.data.get('status', '') == 'pending')
      );
      allow delete: if isAuthenticated() && isAgencyUser();
    }

    match /agencies/{agencyId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && getUserId() == agencyId;
    }

    match /agency_integrations/{integrationId} {
      allow read: if isAuthenticated() && (
        isAgencyUser() ||
        integrationId.matches("^" + request.auth.uid + "(_.*|$)")
      );
      allow create, update, delete: if isAuthenticated() && (
        isAgencyUser() || // Allow agency users to manage their own OR shared integrations
        integrationId.matches("^" + request.auth.uid + "(_.*|$)")
      );
    }

    match /portal_services/{serviceId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAuthenticated() && isAgencyUser();
    }

    match /{document=**} {
      allow read, write: if false;
    }
  }
}

